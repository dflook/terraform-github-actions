FROM debian:buster-slim as base
ARG ARCH=amd64
ARG DEFAULT_TF_VERSION=0.14.4
ARG TFSWITCH_VERSION=0.8.832

# Terraform environment variables
ENV CHECKPOINT_DISABLE=true
ENV TF_IN_AUTOMATION=yep
ENV TF_INPUT=false
ENV TF_PLUGIN_CACHE_DIR=/usr/local/share/terraform/plugin-cache

RUN apt-get update && \
    apt-get install --no-install-recommends -y \
        ca-certificates \
        curl \
        git \
        gzip \
        jq \
        openssh-client \
        python3 \
        python3-pip \
        python3-requests \
        tar \
        unzip \
        wget && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Download, install and configure tfswitch
RUN curl -fsL https://github.com/warrensbox/terraform-switcher/releases/download/${TFSWITCH_VERSION}/terraform-switcher_${TFSWITCH_VERSION}_linux_amd64.tar.gz -o tfswitch.tar.gz && \
    tar -zxvf tfswitch.tar.gz -C /usr/local/bin/ tfswitch  && \
    rm -rf tfswitch.tar.gz && \
    tfswitch $DEFAULT_TF_VERSION && \
    mv /root/.terraform.versions /root/.terraform.versions.default && \
    mkdir -p $TF_PLUGIN_CACHE_DIR

# Download, install and configure tfmask
RUN curl -fsL https://github.com/cloudposse/tfmask/releases/download/0.7.0/tfmask_linux_${ARCH} -o /usr/local/bin/tfmask && \
    chmod 755 /usr/local/bin/tfmask
ENV TFMASK_RESOURCES_REGEX="(?i)^(random_id|kubernetes_secret|acme_certificate).*$"

ENTRYPOINT ["/usr/local/bin/terraform"]
